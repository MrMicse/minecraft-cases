// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
const tg = window.Telegram?.WebApp;
if (tg) {
    tg.expand();
    tg.BackButton?.hide();
    console.log('Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    
    // –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞
    tg.MainButton.text = "–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é";
    tg.MainButton.show();
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let userData = {
    balance: 0,
    experience: 0,
    level: 1
};

let casesData = [];
let inventoryData = [];
let currentCase = null;
let currentItem = null;
let isOpening = false;
let isSyncing = false;

// DOM —ç–ª–µ–º–µ–Ω—Ç—ã
const elements = {
    balance: document.getElementById('user-balance'),
    casesGrid: document.getElementById('cases-grid'),
    inventoryGrid: document.getElementById('inventory-grid'),
    
    // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
    caseModal: document.getElementById('case-modal'),
    inventoryModal: document.getElementById('inventory-modal'),
    resultModal: document.getElementById('result-modal'),
    loadingOverlay: document.getElementById('loading'),
    
    // –ö–Ω–æ–ø–∫–∏
    inventoryBtn: document.getElementById('inventory-btn'),
    closeModal: document.getElementById('close-modal'),
    closeInventory: document.getElementById('close-inventory'),
    closeResult: document.getElementById('close-result'),
    openCaseBtn: document.getElementById('open-case-btn'),
    syncBtn: document.getElementById('sync-btn'),
    
    // –¢–µ–∫—Å—Ç–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    caseName: document.getElementById('case-name'),
    casePriceValue: document.getElementById('case-price-value'),
    openPrice: document.getElementById('open-price'),
    resultItemName: document.getElementById('result-item-name'),
    resultItemRarity: document.getElementById('result-item-rarity'),
    resultItemPrice: document.getElementById('result-item-price'),
    resultItemIcon: document.getElementById('result-icon'),
    newBalance: document.getElementById('new-balance'),
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    notificationArea: document.getElementById('notification-area')
};

// Minecraft –ø—Ä–µ–¥–º–µ—Ç—ã (–¥–µ–º–æ)
const minecraftItems = {
    common: [
        { name: "–ñ–µ–ª–µ–∑–Ω—ã–π –°–ª–∏—Ç–æ–∫", icon: "‚õìÔ∏è", price: 50, description: "–ë–∞–∑–æ–≤—ã–π —Ä–µ—Å—É—Ä—Å" },
        { name: "–£–≥–æ–ª—å", icon: "‚ö´", price: 30, description: "–¢–æ–ø–ª–∏–≤–æ" },
        { name: "–Ø–±–ª–æ–∫–æ", icon: "üçé", price: 40, description: "–ï–¥–∞" },
        { name: "–•–ª–µ–±", icon: "üçû", price: 45, description: "–•–æ—Ä–æ—à–∞—è –µ–¥–∞" }
    ],
    uncommon: [
        { name: "–ê–ª–º–∞–∑", icon: "üíé", price: 150, description: "–¶–µ–Ω–Ω—ã–π –º–∏–Ω–µ—Ä–∞–ª" },
        { name: "–ò–∑—É–º—Ä—É–¥", icon: "üü©", price: 200, description: "–¢–æ—Ä–≥–æ–≤–∞—è –≤–∞–ª—é—Ç–∞" },
        { name: "–ñ–µ–ª–µ–∑–Ω–∞—è –ö–∏—Ä–∞—Å–∞", icon: "üõ°Ô∏è", price: 180, description: "–ó–∞—â–∏—Ç–∞" }
    ],
    rare: [
        { name: "–ù–µ–∑–µ—Ä–∏—Ç–æ–≤—ã–π –°–ª–∏—Ç–æ–∫", icon: "üî±", price: 500, description: "–≠–ª–∏—Ç–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª" },
        { name: "–ö–∏—Ä–æ–∫—Ä—ã–ª–æ", icon: "ü™∂", price: 600, description: "–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ" }
    ],
    epic: [
        { name: "–¢–æ—Ç–µ–º –ë–µ—Å—Å–º–µ—Ä—Ç–∏—è", icon: "üê¶", price: 1000, description: "–°–ø–∞—Å–µ–Ω–∏–µ –æ—Ç —Å–º–µ—Ä—Ç–∏" },
        { name: "–°–µ—Ä–¥—Ü–µ –ú–æ—Ä—è", icon: "üíô", price: 1200, description: "–†–µ–¥–∫–∞—è —Ä–µ–ª–∏–∫–≤–∏—è" }
    ],
    legendary: [
        { name: "–ö–æ–º–∞–Ω–¥–Ω—ã–π –ë–ª–æ–∫", icon: "üü™", price: 5000, description: "–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç" },
        { name: "–ú–µ—á –ù–µ–∑–µ—Ä–∞", icon: "üó°Ô∏è", price: 3000, description: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ –æ—Ä—É–∂–∏–µ" }
    ]
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
async function initApp() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
    showLoading();
    
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
        loadFromLocalStorage();
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º
        await syncWithServer();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateUI();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showNotification('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ë–∞–ª–∞–Ω—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å —Å–µ—Ä–≤–µ—Ä–æ–º.', 'success');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        showNotification('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è.', 'warning');
    }
    
    setTimeout(hideLoading, 500);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
function loadFromLocalStorage() {
    const savedData = localStorage.getItem('minecraftCaseData');
    if (savedData) {
        try {
            const parsed = JSON.parse(savedData);
            userData.balance = parsed.balance || 10000;
            userData.experience = parsed.experience || 0;
            userData.level = parsed.level || 1;
            inventoryData = parsed.inventory || [];
            console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage');
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', e);
            userData.balance = 10000;
        }
    } else {
        userData.balance = 10000;
        saveToLocalStorage();
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
function saveToLocalStorage() {
    const data = {
        balance: userData.balance,
        experience: userData.experience,
        level: userData.level,
        inventory: inventoryData
    };
    localStorage.setItem('minecraftCaseData', JSON.stringify(data));
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
async function syncWithServer() {
    if (isSyncing) return;
    isSyncing = true;
    
    console.log('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...');
    showNotification('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...', 'info');
    
    try {
        const response = await sendDataToBot('init', {});
        
        if (response && response.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
            if (response.user) {
                userData.balance = response.user.balance;
                userData.experience = response.user.experience;
                userData.level = response.user.level;
            }
            
            if (response.inventory) {
                inventoryData = response.inventory;
            }
            
            if (response.cases) {
                casesData = response.cases;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            saveToLocalStorage();
            
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
            showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'success');
            
            return response;
        } else {
            console.warn('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
            loadDemoData();
            return null;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
        loadDemoData();
        showNotification('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.', 'warning');
        return null;
    } finally {
        isSyncing = false;
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö
function loadDemoData() {
    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö...');
    
    casesData = [
        {
            id: 1,
            name: 'üçé –ö–µ–π—Å —Å –ï–¥–æ–π',
            price: 100,
            icon: 'üçé',
            description: '–°–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—É—é –µ–¥—É',
            rarityWeights: { common: 70, uncommon: 30 }
        },
        {
            id: 2,
            name: '‚õèÔ∏è –†–µ—Å—É—Ä—Å–Ω—ã–π –ö–µ–π—Å',
            price: 250,
            icon: '‚õèÔ∏è',
            description: '–†—É–¥—ã, –º–∏–Ω–µ—Ä–∞–ª—ã –∏ –±–∞–∑–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã',
            rarityWeights: { common: 50, uncommon: 40, rare: 10 }
        },
        {
            id: 3,
            name: '‚öîÔ∏è –û—Ä—É–∂–µ–π–Ω—ã–π –ö–µ–π—Å',
            price: 500,
            icon: '‚öîÔ∏è',
            description: '–û—Ä—É–∂–∏–µ, –±—Ä–æ–Ω—è –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã',
            rarityWeights: { uncommon: 40, rare: 50, epic: 10 }
        },
        {
            id: 4,
            name: 'üåü –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ö–µ–π—Å',
            price: 1000,
            icon: 'üåü',
            description: '–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã',
            rarityWeights: { rare: 30, epic: 50, legendary: 20 }
        },
        {
            id: 5,
            name: 'üëë –î–æ—Å—Ç—É–ø–Ω—ã–π –ö–µ–π—Å',
            price: 5000,
            icon: 'üëë',
            description: '–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –¥–æ–Ω–∞—Ç –ø—Ä–µ–¥–º–µ—Ç—ã',
            rarityWeights: { epic: 40, legendary: 60 }
        },
        {
            id: 6,
            name: 'üß∞ –°–ª—É—á–∞–π–Ω—ã–π –ö–µ–π—Å',
            price: 750,
            icon: 'üß∞',
            description: '–ú–∏–∫—Å –∏–∑ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π',
            rarityWeights: { common: 30, uncommon: 40, rare: 20, epic: 10 }
        }
    ];
    
    if (userData.balance === 0) {
        userData.balance = 10000;
    }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
async function sendDataToBot(action, data) {
    return new Promise((resolve) => {
        if (!tg) {
            console.log('Telegram Web App –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º');
            resolve(handleDemoMode(action, data));
            return;
        }
        
        console.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞: ${action}`, data);
        
        const requestData = JSON.stringify({
            action: action,
            ...data,
            timestamp: Date.now()
        });
        
        let responseHandler = null;
        
        responseHandler = async (event) => {
            if (event.data && event.data.type === 'message') {
                try {
                    const message = event.data;
                    
                    if (message.text) {
                        const parsedData = JSON.parse(message.text);
                        
                        if (window._botResponseHandler === responseHandler) {
                            window.removeEventListener('message', responseHandler);
                            window._botResponseHandler = null;
                        }
                        
                        resolve(parsedData);
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
                    
                    if (window._botResponseHandler === responseHandler) {
                        window.removeEventListener('message', responseHandler);
                        window._botResponseHandler = null;
                    }
                    
                    resolve(handleDemoMode(action, data));
                }
            }
        };
        
        window._botResponseHandler = responseHandler;
        window.addEventListener('message', responseHandler);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        tg.sendData(requestData);
        
        // –¢–∞–π–º–∞—É—Ç
        setTimeout(() => {
            if (window._botResponseHandler === responseHandler) {
                window.removeEventListener('message', responseHandler);
                window._botResponseHandler = null;
            }
            
            console.warn(`–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞: ${action}`);
            resolve(handleDemoMode(action, data));
        }, 3000);
    });
}

// –î–µ–º–æ-—Ä–µ–∂–∏–º
function handleDemoMode(action, data) {
    console.log(`–î–µ–º–æ-—Ä–µ–∂–∏–º: ${action}`, data);
    
    switch (action) {
        case 'init':
            return {
                success: true,
                user: {
                    balance: userData.balance,
                    experience: userData.experience,
                    level: userData.level
                },
                inventory: inventoryData,
                cases: casesData,
                config: {
                    min_bet: 10,
                    max_bet: 10000,
                    daily_bonus: 100,
                    version: '1.0.0'
                }
            };
            
        case 'open_case':
            const caseItem = casesData.find(c => c.id === data.case_id);
            if (!caseItem) {
                return { success: false, error: '–ö–µ–π—Å –Ω–µ –Ω–∞–π–¥–µ–Ω' };
            }
            
            if (userData.balance < caseItem.price) {
                return { success: false, error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤' };
            }
            
            const wonItem = generateWonItem(caseItem);
            userData.balance -= caseItem.price;
            
            inventoryData.unshift({
                ...wonItem,
                id: Date.now(),
                obtained_at: new Date().toISOString()
            });
            
            saveToLocalStorage();
            
            return {
                success: true,
                item: wonItem,
                new_balance: userData.balance,
                experience_gained: caseItem.price / 10,
                user: {
                    balance: userData.balance,
                    experience: userData.experience,
                    level: userData.level
                },
                inventory: inventoryData
            };
            
        case 'sync_balance':
            const newBalance = data.balance;
            const oldBalance = userData.balance;
            
            if (newBalance !== undefined) {
                userData.balance = newBalance;
                saveToLocalStorage();
                
                return {
                    success: true,
                    user: {
                        balance: userData.balance,
                        experience: userData.experience,
                        level: userData.level
                    },
                    message: `–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω: ${oldBalance} ‚Üí ${newBalance}`
                };
            }
            
            return { success: false, error: '–ù–µ —É–∫–∞–∑–∞–Ω –±–∞–ª–∞–Ω—Å' };
            
        default:
            return { success: false, error: '–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' };
    }
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
async function syncBalanceWithServer() {
    console.log(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞: ${userData.balance}`);
    
    try {
        const response = await sendDataToBot('sync_balance', {
            balance: userData.balance,
            old_balance: userData.balance,
            timestamp: Date.now()
        });
        
        if (response && response.success) {
            console.log('‚úÖ –ë–∞–ª–∞–Ω—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            
            if (response.user) {
                userData.balance = response.user.balance;
                updateUI();
                saveToLocalStorage();
            }
            
            showNotification('‚úÖ –ë–∞–ª–∞–Ω—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ', 'success');
            return true;
        } else {
            console.warn('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–∞–ª–∞–Ω—Å–∞');
            showNotification('‚ö†Ô∏è –ë–∞–ª–∞–Ω—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ', 'warning');
            return false;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–∞–ª–∞–Ω—Å–∞:', error);
        showNotification('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
        return false;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
function updateUI() {
    if (elements.balance) {
        elements.balance.textContent = userData.balance.toLocaleString();
    }
    renderCases();
    renderInventory();
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–µ–π—Å–æ–≤
function renderCases() {
    if (!elements.casesGrid) return;
    
    elements.casesGrid.innerHTML = '';
    
    if (!casesData || casesData.length === 0) {
        loadDemoData();
    }
    
    casesData.forEach((caseItem, index) => {
        const caseCard = document.createElement('div');
        caseCard.className = 'case-card';
        caseCard.dataset.id = caseItem.id;
        caseCard.style.setProperty('--index', index);
        
        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è –ø—Ä–µ–≤—å—é
        const previewItems = getPreviewItems(caseItem);
        
        caseCard.innerHTML = `
            <div class="case-image">
                <div class="case-icon">${caseItem.icon}</div>
                <div class="case-glow"></div>
                <div class="case-items-preview">
                    ${previewItems.map(item => `<span>${item.icon}</span>`).join('')}
                </div>
            </div>
            <div class="case-info">
                <h3 class="case-name">${caseItem.name}</h3>
                <p class="case-price">${caseItem.price} üíé</p>
                <p class="case-description">${caseItem.description}</p>
            </div>
        `;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        let touchStartTime = 0;
        
        caseCard.addEventListener('touchstart', (e) => {
            touchStartTime = Date.now();
            e.preventDefault();
        }, { passive: false });
        
        caseCard.addEventListener('touchend', (e) => {
            if (Date.now() - touchStartTime < 500) {
                openCaseModal(caseItem);
            }
            e.preventDefault();
        }, { passive: false });
        
        caseCard.addEventListener('click', () => {
            if (Date.now() - touchStartTime > 100) {
                openCaseModal(caseItem);
            }
        });
        
        elements.casesGrid.appendChild(caseCard);
    });
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥–ª—è –ø—Ä–µ–≤—å—é
function getPreviewItems(caseItem) {
    const previewItems = [];
    const allItems = [];
    
    for (const [rarity, weight] of Object.entries(caseItem.rarityWeights)) {
        if (weight > 0) {
            const items = minecraftItems[rarity] || [];
            allItems.push(...items);
        }
    }
    
    const count = Math.min(4, allItems.length);
    const shuffledItems = [...allItems].sort(() => Math.random() - 0.5);
    
    for (let i = 0; i < count; i++) {
        if (shuffledItems[i]) {
            previewItems.push(shuffledItems[i]);
        }
    }
    
    return previewItems;
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
function renderInventory() {
    if (!elements.inventoryGrid) return;
    
    elements.inventoryGrid.innerHTML = '';
    
    if (inventoryData.length === 0) {
        elements.inventoryGrid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">üéí</div>
                <p style="color: var(--text-secondary); font-size: 1.1rem;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px;">
                    –û—Ç–∫—Ä–æ–π—Ç–µ –∫–µ–π—Å—ã, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã!
                </p>
            </div>
        `;
        return;
    }
    
    inventoryData.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'inventory-item';
        itemElement.dataset.rarity = item.rarity;
        
        itemElement.innerHTML = `
            <div class="item-icon">${item.icon || 'üì¶'}</div>
            <h4>${item.name}</h4>
            <span class="item-rarity ${item.rarity}">${getRarityText(item.rarity)}</span>
            <p style="font-size: 0.8rem; color: var(--accent-diamond); margin-top: 5px;">
                üíé ${item.price || 0}
            </p>
        `;
        
        itemElement.addEventListener('click', () => viewItem(item));
        elements.inventoryGrid.appendChild(itemElement);
    });
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—ã–∏–≥—Ä—ã—à–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
function generateWonItem(caseItem) {
    const totalWeight = Object.values(caseItem.rarityWeights).reduce((a, b) => a + b, 0);
    let randomWeight = Math.random() * totalWeight;
    
    let selectedRarity = 'common';
    for (const [rarity, weight] of Object.entries(caseItem.rarityWeights)) {
        randomWeight -= weight;
        if (randomWeight <= 0) {
            selectedRarity = rarity;
            break;
        }
    }
    
    const itemsByRarity = {
        common: minecraftItems.common,
        uncommon: minecraftItems.uncommon,
        rare: minecraftItems.rare,
        epic: minecraftItems.epic,
        legendary: minecraftItems.legendary
    };
    
    const availableItems = itemsByRarity[selectedRarity] || minecraftItems.common;
    const randomItem = {...availableItems[Math.floor(Math.random() * availableItems.length)]};
    randomItem.rarity = selectedRarity;
    randomItem.id = Date.now();
    
    return randomItem;
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞ - –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –° –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ï–ô
async function openCase() {
    console.log('–û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞...');
    
    if (!currentCase || isOpening) {
        console.log('–ù–µ –º–æ–≥—É –æ—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å');
        return;
    }
    
    if (userData.balance < currentCase.price) {
        showNotification('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤!', 'error');
        return;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å
    const oldBalance = userData.balance;
    
    // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ª–æ–∫–∞–ª—å–Ω–æ
    userData.balance -= currentCase.price;
    updateUI();
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
    elements.openCaseBtn.disabled = true;
    elements.openCaseBtn.innerHTML = '‚è≥ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è...';
    isOpening = true;
    
    try {
        // –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è (–±–µ–∑ —Ä—É–ª–µ—Ç–∫–∏)
        await simpleAnimation();
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–µ–¥–º–µ—Ç
        const wonItem = generateWonItem(currentCase);
        currentItem = wonItem;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
        inventoryData.unshift({
            ...wonItem,
            id: Date.now(),
            obtained_at: new Date().toISOString()
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        saveToLocalStorage();
        
        // –°–ò–ù–•–†–û–ù–ò–ó–ò–†–£–ï–ú –° –°–ï–†–í–ï–†–û–ú
        const syncResult = await syncBalanceWithServer();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        showResult(wonItem);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateUI();
        
        if (!syncResult) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å
            setTimeout(() => {
                showNotification('‚ö†Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ', 'warning');
            }, 2000);
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–µ–π—Å–∞:', error);
        
        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
        userData.balance = oldBalance;
        updateUI();
        
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–µ–π—Å–∞', 'error');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        elements.openCaseBtn.disabled = false;
        elements.openCaseBtn.innerHTML = `‚õèÔ∏è –û—Ç–∫—Ä—ã—Ç—å –∑–∞ ${currentCase.price} üíé`;
        isOpening = false;
    }
}

// –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è
function simpleAnimation() {
    return new Promise((resolve) => {
        const modal = elements.caseModal;
        if (!modal) {
            resolve();
            return;
        }
        
        const caseImage = modal.querySelector('.case-image');
        if (caseImage) {
            caseImage.classList.add('opening');
            
            setTimeout(() => {
                caseImage.classList.remove('opening');
                caseImage.classList.add('opened');
                
                setTimeout(() => {
                    caseImage.classList.remove('opened');
                    resolve();
                }, 500);
            }, 1000);
        } else {
            setTimeout(resolve, 1000);
        }
    });
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
function showResult(item) {
    console.log('–ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', item);
    
    elements.resultItemName.textContent = item.name;
    elements.resultItemRarity.textContent = getRarityText(item.rarity);
    elements.resultItemRarity.className = `item-rarity ${item.rarity}`;
    elements.resultItemPrice.textContent = item.price.toLocaleString();
    elements.resultItemIcon.innerHTML = `<div class="item-icon-large">${item.icon}</div>`;
    elements.newBalance.textContent = userData.balance.toLocaleString();
    
    // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç —á–∞—Å—Ç–∏—Ü
    createParticles();
    
    showModal(elements.resultModal);
}

// –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
function createParticles() {
    const particleContainer = document.querySelector('.particle-effect');
    if (!particleContainer) return;
    
    particleContainer.innerHTML = '';
    
    const colors = {
        common: '#4b69ff',
        uncommon: '#00d26a',
        rare: '#ffd700',
        epic: '#8847ff',
        legendary: '#ff0000'
    };
    
    const color = colors[currentItem.rarity] || '#4b69ff';
    
    for (let i = 0; i < 15; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        const size = 5 + Math.random() * 10;
        const angle = (i / 15) * Math.PI * 2;
        const distance = 50 + Math.random() * 100;
        
        particle.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            background: ${color};
            border-radius: 50%;
            left: 50%;
            top: 50%;
            opacity: 0;
            animation: particleExplode 1s ease-out ${i * 0.03}s forwards;
            --end-x: ${Math.cos(angle) * distance}px;
            --end-y: ${Math.sin(angle) * distance}px;
            filter: drop-shadow(0 0 5px ${color});
        `;
        
        particleContainer.appendChild(particle);
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ä–µ–¥–∫–æ—Å—Ç–∏
function getRarityText(rarity) {
    const rarityMap = {
        'common': '–û–±—ã—á–Ω—ã–π',
        'uncommon': '–ù–µ–æ–±—ã—á–Ω—ã–π',
        'rare': '–†–µ–¥–∫–∏–π',
        'epic': '–≠–ø–∏—á–µ—Å–∫–∏–π',
        'legendary': '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π'
    };
    return rarityMap[rarity] || rarity;
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–µ–¥–º–µ—Ç–∞
function viewItem(item) {
    alert(`üéÅ ${item.name}\nüéØ –†–µ–¥–∫–æ—Å—Ç—å: ${getRarityText(item.rarity)}\nüíé –¶–µ–Ω–∞: ${item.price}\nüìù ${item.description || ''}`);
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–µ–π—Å–∞
function openCaseModal(caseItem) {
    console.log('–û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–µ–π—Å–∞:', caseItem.name);
    currentCase = caseItem;
    
    elements.caseName.textContent = caseItem.name;
    elements.casePriceValue.textContent = caseItem.price;
    elements.openPrice.textContent = caseItem.price;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
    if (userData.balance < caseItem.price) {
        elements.openCaseBtn.disabled = true;
        elements.openCaseBtn.innerHTML = '‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ üíé';
    } else {
        elements.openCaseBtn.disabled = false;
        elements.openCaseBtn.innerHTML = `‚õèÔ∏è –û—Ç–∫—Ä—ã—Ç—å –∑–∞ ${caseItem.price} üíé`;
    }
    
    showModal(elements.caseModal);
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
function openInventoryModal() {
    console.log('–û—Ç–∫—Ä—ã—Ç–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è');
    renderInventory();
    showModal(elements.inventoryModal);
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
async function syncData() {
    showNotification('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...', 'info');
    
    const result = await syncWithServer();
    
    if (result) {
        updateUI();
        showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
    } else {
        showNotification('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', 'warning');
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
    console.log(`–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ [${type}]: ${message}`);
    
    if (!elements.notificationArea) {
        // –°–æ–∑–¥–∞–µ–º –æ–±–ª–∞—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        const notificationArea = document.createElement('div');
        notificationArea.id = 'notification-area';
        notificationArea.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        `;
        document.body.appendChild(notificationArea);
        elements.notificationArea = notificationArea;
    }
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <span>${message}</span>
            <button class="notification-close">&times;</button>
        </div>
    `;
    
    notification.querySelector('.notification-close').addEventListener('click', () => {
        notification.remove();
    });
    
    elements.notificationArea.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        }
    }, 5000);
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
function showModal(modal) {
    if (!modal) return;
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function hideModal(modal) {
    if (!modal) return;
    modal.classList.remove('active');
    document.body.style.overflow = 'auto';
}

function showLoading() {
    if (elements.loadingOverlay) {
        elements.loadingOverlay.style.display = 'flex';
        setTimeout(() => {
            elements.loadingOverlay.style.opacity = '1';
        }, 10);
    }
}

function hideLoading() {
    if (elements.loadingOverlay) {
        elements.loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            elements.loadingOverlay.style.display = 'none';
        }, 300);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
function initEventListeners() {
    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π...');
    
    // –ö–Ω–æ–ø–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    if (elements.inventoryBtn) {
        elements.inventoryBtn.addEventListener('click', openInventoryModal);
    }
    
    // –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    if (elements.syncBtn) {
        elements.syncBtn.addEventListener('click', syncData);
    }
    
    // –ö–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
    if (elements.closeModal) {
        elements.closeModal.addEventListener('click', () => hideModal(elements.caseModal));
    }
    
    if (elements.closeInventory) {
        elements.closeInventory.addEventListener('click', () => hideModal(elements.inventoryModal));
    }
    
    if (elements.closeResult) {
        elements.closeResult.addEventListener('click', () => hideModal(elements.resultModal));
    }
    
    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞
    if (elements.openCaseBtn) {
        elements.openCaseBtn.addEventListener('click', openCase);
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay && !isOpening) {
                if (overlay === elements.caseModal) {
                    hideModal(elements.caseModal);
                } else if (overlay === elements.inventoryModal) {
                    hideModal(elements.inventoryModal);
                } else if (overlay === elements.resultModal) {
                    hideModal(elements.resultModal);
                }
            }
        });
    });
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
            setTimeout(syncData, 1000);
        }
    });
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', () => {
        setTimeout(syncData, 2000);
    });
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    initApp();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    initEventListeners();
    
    console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ');
});